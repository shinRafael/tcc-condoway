=============================================================
üì∏ PROMPT PARA O BACKEND - UPLOAD DE FOTO DE PERFIL
=============================================================

O frontend agora est√° enviando fotos de perfil de usu√°rios durante o cadastro e atualiza√ß√£o.
Voc√™ precisa implementar o upload de imagens no backend.

=============================================================
1. ENDPOINT DE CADASTRO DE USU√ÅRIO (ATUALIZADO)
=============================================================

POST /Usuario

ANTES recebia: Content-Type: application/json
AGORA recebe: Content-Type: multipart/form-data

Body (FormData):
- user_nome: string (obrigat√≥rio)
- user_email: string (obrigat√≥rio)
- user_senha: string (obrigat√≥rio)
- user_telefone: string (opcional)
- user_tipo: "Sindico" | "Funcionario" | "Morador" (obrigat√≥rio)
- foto: File (arquivo de imagem - OPCIONAL)

Response esperada (Status 200):
{
  "sucesso": true,
  "mensagem": "Usu√°rio cadastrado com sucesso.",
  "dados": {
    "id": 123,
    "user_nome": "Jo√£o Silva",
    "user_email": "joao@email.com",
    "user_tipo": "Morador",
    "user_foto": "/uploads/perfil/123456789.jpg"  // ‚Üê NOVO CAMPO
  }
}

=============================================================
2. ENDPOINT DE ATUALIZA√á√ÉO DE USU√ÅRIO (ATUALIZADO)
=============================================================

PATCH /Usuario/:id

Pode receber:
- Content-Type: application/json (se N√ÉO houver foto nova)
- Content-Type: multipart/form-data (se HOUVER foto nova)

Body (JSON ou FormData):
- user_nome: string (opcional)
- user_email: string (opcional)
- user_senha: string (opcional - se vazio, n√£o atualizar)
- user_telefone: string (opcional)
- user_tipo: string (opcional)
- foto: File (arquivo de imagem - OPCIONAL)

Response esperada (Status 200):
{
  "sucesso": true,
  "mensagem": "Usu√°rio atualizado com sucesso.",
  "dados": {
    "user_id": 123,
    "user_foto": "/uploads/perfil/987654321.jpg"  // ‚Üê NOVO CAMPO (se foi atualizada)
  }
}

=============================================================
3. IMPLEMENTA√á√ÉO DO UPLOAD NO BACKEND
=============================================================

Voc√™ precisa:

A) INSTALAR BIBLIOTECA DE UPLOAD (exemplo com Multer para Node.js):
   npm install multer

B) CONFIGURAR O MULTER:

const multer = require('multer');
const path = require('path');
const fs = require('fs');

// Cria a pasta de uploads se n√£o existir
const uploadDir = path.join(__dirname, '..', 'uploads', 'perfil');
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true });
}

// Configura√ß√£o do storage
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, uploadDir);
  },
  filename: function (req, file, cb) {
    // Gera nome √∫nico: timestamp + extens√£o original
    const uniqueName = Date.now() + '-' + Math.round(Math.random() * 1E9);
    const ext = path.extname(file.originalname);
    cb(null, uniqueName + ext);
  }
});

// Filtro para aceitar apenas imagens
const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|gif|webp/;
  const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
  const mimetype = allowedTypes.test(file.mimetype);

  if (mimetype && extname) {
    return cb(null, true);
  } else {
    cb(new Error('Apenas imagens s√£o permitidas (JPG, PNG, GIF, WEBP)'));
  }
};

// Middleware de upload
const upload = multer({
  storage: storage,
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB
  fileFilter: fileFilter
});

module.exports = upload;

C) USAR O MIDDLEWARE NAS ROTAS:

const upload = require('./middleware/upload'); // Ajuste o caminho

// Rota de cadastro
router.post('/Usuario', upload.single('foto'), UsuarioController.criar);

// Rota de atualiza√ß√£o
router.patch('/Usuario/:id', upload.single('foto'), UsuarioController.atualizar);

D) NO CONTROLLER, SALVAR O CAMINHO DA FOTO:

// Exemplo no m√©todo criar()
const criar = async (req, res) => {
  try {
    const { user_nome, user_email, user_senha, user_telefone, user_tipo } = req.body;
    
    // Se houver arquivo enviado, pega o caminho
    const user_foto = req.file ? `/uploads/perfil/${req.file.filename}` : null;

    // Salva no banco (adicione o campo user_foto na tabela usuarios)
    const query = `
      INSERT INTO usuarios (user_nome, user_email, user_senha, user_telefone, user_tipo, user_foto)
      VALUES (?, ?, ?, ?, ?, ?)
    `;
    
    const result = await db.execute(query, [
      user_nome,
      user_email,
      hashedPassword, // Hash da senha
      user_telefone,
      user_tipo,
      user_foto
    ]);

    res.status(200).json({
      sucesso: true,
      mensagem: "Usu√°rio cadastrado com sucesso.",
      dados: {
        id: result.insertId,
        user_nome,
        user_email,
        user_tipo,
        user_foto
      }
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ mensagem: "Erro ao cadastrar usu√°rio" });
  }
};

=============================================================
4. BANCO DE DADOS - ADICIONAR CAMPO
=============================================================

Execute no MySQL:

ALTER TABLE usuarios 
ADD COLUMN user_foto VARCHAR(255) NULL;

=============================================================
5. SERVIR ARQUIVOS EST√ÅTICOS (Express.js)
=============================================================

No arquivo principal (app.js ou server.js):

const express = require('express');
const path = require('path');
const app = express();

// Servir arquivos est√°ticos da pasta uploads
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

Isso permite que o frontend acesse as imagens via:
http://localhost:3333/uploads/perfil/123456789.jpg

=============================================================
6. ENDPOINT GET /Usuario DEVE RETORNAR user_foto
=============================================================

Quando buscar usu√°rios, inclua o campo user_foto:

SELECT 
  user_id,
  user_nome,
  user_email,
  user_tipo,
  user_telefone,
  user_foto  -- ‚Üê ADICIONAR ESTE CAMPO
FROM usuarios;

=============================================================
7. VALIDA√á√ïES IMPORTANTES
=============================================================

- Arquivo √© OPCIONAL (nem sempre o usu√°rio vai enviar foto)
- Tamanho m√°ximo: 5MB
- Formatos aceitos: JPG, JPEG, PNG, GIF, WEBP
- Se atualizar usu√°rio SEM enviar foto, manter a foto existente
- Se atualizar COM foto nova, DELETAR a foto antiga do servidor

Exemplo para deletar foto antiga:

const fs = require('fs');
const path = require('path');

// Antes de salvar nova foto, deletar a antiga
if (usuarioAntigo.user_foto) {
  const caminhoAntigo = path.join(__dirname, '..', usuarioAntigo.user_foto);
  if (fs.existsSync(caminhoAntigo)) {
    fs.unlinkSync(caminhoAntigo);
  }
}

=============================================================
8. CORS - IMPORTANTE!
=============================================================

Certifique-se de que o CORS est√° permitindo multipart/form-data:

app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true
}));

=============================================================
9. TESTE MANUAL
=============================================================

Voc√™ pode testar com Postman ou Insomnia:

1. Criar request POST para http://localhost:3333/Usuario
2. Em Body, selecionar "form-data"
3. Adicionar os campos:
   - user_nome: "Teste"
   - user_email: "teste@email.com"
   - user_senha: "123456"
   - user_tipo: "Morador"
   - foto: [selecionar arquivo de imagem]

=============================================================
10. ESTRUTURA DE PASTAS NO BACKEND
=============================================================

backend/
‚îú‚îÄ‚îÄ uploads/
‚îÇ   ‚îî‚îÄ‚îÄ perfil/
‚îÇ       ‚îú‚îÄ‚îÄ 1234567890-foto1.jpg
‚îÇ       ‚îî‚îÄ‚îÄ 9876543210-foto2.png
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsuarioController.js
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload.js
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ usuario.routes.js
‚îî‚îÄ‚îÄ server.js

=============================================================

IMPORTANTE: Ap√≥s implementar, confirme que:
‚úÖ POST /Usuario aceita multipart/form-data com campo "foto"
‚úÖ PATCH /Usuario/:id aceita multipart/form-data com campo "foto"
‚úÖ GET /Usuario retorna o campo "user_foto" para cada usu√°rio
‚úÖ Arquivos s√£o salvos em /uploads/perfil/
‚úÖ Arquivos s√£o acess√≠veis via http://localhost:3333/uploads/perfil/nome-arquivo.jpg
‚úÖ Tabela usuarios tem a coluna user_foto
